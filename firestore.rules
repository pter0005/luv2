rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Lovepages are public to read.
    // Writes are protected: only the owner of the page can write.
    // Also prevents privilege escalation by blocking 'role' field.
    match /lovepages/{lovepageId} {
      allow read: if true;
      allow write: if request.auth != null && 
                   request.resource.data.userId == request.auth.uid &&
                   (resource == null || resource.data.userId == request.auth.uid) &&
                   !('role' in request.resource.data); // Prevent privilege escalation
    }

    // User data can only be read/written by the user themselves.
    match /users/{userId}/{documents=**} {
      allow read, write: if request.auth.uid == userId;
    }

    // Payment intents have granular permissions.
    match /payment_intents/{intentId} {
       allow read, delete: if request.auth.uid == resource.data.userId;
       allow create: if request.auth.uid == request.resource.data.userId;
       allow update: if request.auth.uid == resource.data.userId
                     && request.resource.data.userId == resource.data.userId // Owner cannot be changed
                     // Status cannot be changed to 'completed' by the client.
                     && (!('status' in request.resource.data) || request.resource.data.status != 'completed');
    }

    // Templates are public to read, but not writable by clients.
    match /templates/{templateId} {
        allow read: if true;
        allow write: if false; // Assumes only backend/admin can write
    }
  }
}
